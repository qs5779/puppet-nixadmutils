#!/bin/bash
# -*- Mode: Bash; tab-width: 2; indent-tabs-mode: nil -*- vim:sta:et:sw=2:ts=2:syntax=sh
#
# Revision History:
# 20190317 - que - initial version
# 20190806 - que - gentoo support
# 20190822 - que - archlinux support
#

tmpfile=$(mktemp /tmp/pkgs.XXXXXXXX) || exit 1

FAM=$(facter osfamily)

case "$FAM" in
  Debian )
    apt list --installed | sort > "$tmpfile"
    oldfile='/var/log/aptpkgs'
  ;;
  RedHat )
    oldfile='/var/log/rpmpkgs'
    rpm -qa --qf '%{name}-%{version}-%{release}.%{arch}.rpm\n' 2>&1 | sort > "$tmpfile"
  ;;
  Gentoo )
    qlist -Iv > "$tmpfile"
    oldfile='/var/log/gtpkgs'
  ;;
  Archlinux )
    pacman -Qe > "$tmpfile"
    oldfile='/var/log/archpkgs'
  ;;
  * )
    echo "Unsupported osfamily: $FAM" >&2
    exit 1
  ;;
esac

outfile=/var/log/pkglist

if [ -w "$outfile" ]
then
  writable=1
  diff -q "$tmpfile" "$outfile" > /dev/null
  differs=$?
elif [ -w "$(dirname "$outfile")" ]
then
  writable=1
  differs=1
else
  writable=0
  differs=0
fi

if [ $writable -ne 0 -a $differs -eq 1 ]
then
  if [ -f "$oldfile" ]
  then
    rm -f "$oldfile" 2>/dev/null
  fi
  cat "$tmpfile" > "$outfile"
# else
#   echo "writable: $writable"
#   echo "differs:  $differs"
fi

if [ -t 0 ]
then
  cat "$tmpfile"
fi

rm -rf "$tmpfile"

exit $?
